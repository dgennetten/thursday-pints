name: Process New Visit

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  process-visit:
    # Run for all issue events except deleted
    if: github.event_name == 'issues' && github.event.action != 'deleted'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Check if issue is a visit issue
        id: check
        run: |
          TITLE="${{ github.event.issue.title }}"
          LABELS="${{ toJSON(github.event.issue.labels) }}"
          
          echo "Issue title: $TITLE"
          echo "Issue labels: $LABELS"
          echo "Action: ${{ github.event.action }}"
          
          # Check if title contains "[Visit]" or has 'visit' label
          if echo "$TITLE" | grep -qi "\[Visit\]" || echo "$LABELS" | grep -qi '"name".*"visit"'; then
            echo "is_visit=true" >> $GITHUB_OUTPUT
            echo "This is a visit issue - proceeding"
          else
            echo "is_visit=false" >> $GITHUB_OUTPUT
            echo "This is NOT a visit issue - skipping"
            echo "Title check: $(echo "$TITLE" | grep -qi "\[Visit\]" && echo "MATCH" || echo "NO MATCH")"
            echo "Label check: $(echo "$LABELS" | grep -qi '"name".*"visit"' && echo "MATCH" || echo "NO MATCH")"
          fi
      
      - name: Comment on issue (always)
        uses: actions/github-script@v7
        with:
          script: |
            const isVisit = '${{ steps.check.outputs.is_visit }}' === 'true';
            const title = context.payload.issue.title;
            const labels = context.payload.issue.labels.map(l => l.name).join(', ');
            
            if (isVisit) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'üîÑ Processing visit issue...\n\n' +
                      `- **Title:** ${title}\n` +
                      `- **Labels:** ${labels || '(none)'}\n` +
                      `- **Status:** Identified as visit issue - processing will continue.`
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚ö†Ô∏è This issue was not identified as a visit issue.\n\n' +
                      `- **Title:** ${title}\n` +
                      `- **Labels:** ${labels || '(none)'}\n` +
                      `- **Status:** Skipping processing.\n\n` +
                      'To process this as a visit, ensure:\n' +
                      '1. The title starts with "[Visit]" (case-insensitive), OR\n' +
                      '2. The issue has a "visit" label'
              });
            }
      
      - name: Checkout repository
        if: steps.check.outputs.is_visit == 'true'
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: steps.check.outputs.is_visit == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check.outputs.is_visit == 'true'
        run: npm ci
      
      - name: Parse issue data
        if: steps.check.outputs.is_visit == 'true'
        id: parse
        run: |
          # Use Node.js to parse GitHub issue form data more reliably
          node << 'EOF'
          const body = `${{ github.event.issue.body }}`;
          
          // GitHub issue forms use markdown format like:
          // ### Visit Date
          // 2026-02-12
          // ### Brewery Name
          // High Hops Brewery
          
          function extractField(body, fieldName) {
            const regex = new RegExp(`###\\s+${fieldName}[\\s\\S]*?\\n([\\s\\S]*?)(?=###|$)`, 'i');
            const match = body.match(regex);
            if (!match) return null;
            
            let value = match[1].trim();
            // Remove markdown formatting and clean up
            value = value.replace(/\*\*/g, '').replace(/^[-*]\s*/, '').trim();
            
            // Handle "No response" or empty values
            if (!value || value === 'No response' || value === 'N/A') {
              return null;
            }
            
            return value;
          }
          
          let date = extractField(body, 'Visit Date');
          const brewery = extractField(body, 'Brewery Name');
          let nextBrewery = extractField(body, 'Next Brewery');
          const notes = extractField(body, 'Notes');
          
          // If date is empty, calculate next Thursday
          if (!date) {
            const d = new Date();
            const day = d.getDay();
            const diff = (4 - day + 7) % 7 || 7; // Thursday is day 4
            d.setDate(d.getDate() + diff);
            date = d.toISOString().split('T')[0];
            console.log(`Calculated next Thursday: ${date}`);
          }
          
          // Validate required fields
          if (!brewery) {
            console.error('Error: Missing required field - Brewery Name');
            process.exit(1);
          }
          
          // Check if date is less than a week old
          const visitDate = new Date(date);
          const today = new Date();
          const daysDiff = Math.floor((today - visitDate) / (1000 * 60 * 60 * 24));
          const isRecent = daysDiff < 7;
          
          // Next Brewery is required only for recent visits (less than a week old)
          if (isRecent && !nextBrewery) {
            console.error('Error: Next Brewery is required for recent visits (within the last week)');
            console.error(`Visit date: ${date} (${daysDiff} days ago)`);
            process.exit(1);
          }
          
          // For old data, nextBrewery can be null/undefined
          if (!isRecent && !nextBrewery) {
            console.log(`Note: Next Brewery not provided for historical data (${daysDiff} days old) - this is OK`);
          }
          
          // Output to GitHub Actions
          const fs = require('fs');
          const outputFile = process.env.GITHUB_OUTPUT;
          if (outputFile) {
            fs.appendFileSync(outputFile, `date=${date}\n`);
            fs.appendFileSync(outputFile, `brewery=${brewery.replace(/\n/g, ' ')}\n`);
            // Only add next_brewery if it exists
            if (nextBrewery) {
              fs.appendFileSync(outputFile, `next_brewery=${nextBrewery.replace(/\n/g, '\\n')}\n`);
            } else {
              fs.appendFileSync(outputFile, `next_brewery=\n`);
            }
            fs.appendFileSync(outputFile, `notes=${(notes || '').replace(/\n/g, ' ')}\n`);
          } else {
            // Fallback for testing
            console.log(`::set-output name=date::${date}`);
            console.log(`::set-output name=brewery::${brewery}`);
            console.log(`::set-output name=next_brewery::${nextBrewery}`);
            console.log(`::set-output name=notes::${notes || ''}`);
          }
          
          console.log('Parsed values:');
          console.log(`  Date: ${date}`);
          console.log(`  Brewery: ${brewery}`);
          console.log(`  Next Brewery: ${nextBrewery}`);
          console.log(`  Notes: ${notes || '(none)'}`);
          EOF
        continue-on-error: false
      
      - name: Update data.json
        if: steps.check.outputs.is_visit == 'true'
        run: |
          # Build command with optional next-brewery
          CMD="node scripts/add-visit.js --date \"${{ steps.parse.outputs.date }}\" --brewery \"${{ steps.parse.outputs.brewery }}\""
          if [ -n "${{ steps.parse.outputs.next_brewery }}" ]; then
            CMD="$CMD --next-brewery \"${{ steps.parse.outputs.next_brewery }}\""
          fi
          if [ -n "${{ steps.parse.outputs.notes }}" ]; then
            CMD="$CMD --notes \"${{ steps.parse.outputs.notes }}\""
          fi
          eval $CMD
      
      - name: Build application
        if: steps.check.outputs.is_visit == 'true'
        run: npm run build
      
      - name: Commit changes
        if: steps.check.outputs.is_visit == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/data.json dist/data.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - data.json may already contain this visit"
          else
            echo "Committing changes..."
            git commit -m "Add visit: ${{ steps.parse.outputs.date }} - ${{ steps.parse.outputs.brewery }}"
            git push
            echo "Changes committed and pushed successfully"
          fi
      
      - name: Deploy to Dreamhost via FTP
        if: steps.check.outputs.is_visit == 'true'
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /public_html/
          local-dir: ./dist/
          dangerous-clean-slate: false
      
      - name: Comment on issue with results
        if: steps.check.outputs.is_visit == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.parse.outputs.date }}';
            const brewery = '${{ steps.parse.outputs.brewery }}';
            const nextBrewery = '${{ steps.parse.outputs.next_brewery }}';
            const notes = '${{ steps.parse.outputs.notes }}';
            
            let body = '‚úÖ Visit added and deployed successfully!\n\n';
            body += `- **Date:** ${date}\n`;
            body += `- **Brewery:** ${brewery}\n`;
            if (nextBrewery && nextBrewery.trim() !== '') {
              body += `- **Next Brewery:** ${nextBrewery}\n`;
            } else {
              body += '- **Next Brewery:** (not provided for historical data)\n';
            }
            if (notes && notes.trim() !== '') {
              body += `- **Notes:** ${notes}\n`;
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
        continue-on-error: true
      
      - name: Handle errors
        if: failure() && steps.check.outputs.is_visit == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Error processing visit. Please check the workflow logs for details.'
            })
